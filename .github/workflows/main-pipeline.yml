name: Main Pipeline

permissions:
  contents: read
  pull-requests: write
  packages: write
  id-token: write

on:
  push:
    branches: [main, staging]
    paths:
      - ".github/workflows/main-pipeline.yml"
      - ".github/workflows/docker-build-push.yml"
      - ".github/workflows/terraform-deploy.yml"
      - ".github/workflows/tests.yml"
      - ".github/workflows/dbt-metabase-sync.yml"
      - "api/**"
      - "app/**"
      - "analytics/**"
      - "widget/**"
      - "terraform/**"

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect analytics changes
    runs-on: ubuntu-latest
    outputs:
      analytics: ${{ steps.filter.outputs.analytics }}
    steps:
      - uses: actions/checkout@v5
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            analytics:
              - 'analytics/**'

  test:
    needs: detect-changes
    uses: ./.github/workflows/tests.yml
    permissions:
      contents: read
      actions: write
    secrets: inherit
    with:
      branch: ${{ github.ref_name }}

  build:
    needs: test
    uses: ./.github/workflows/docker-build-push.yml
    secrets: inherit
    with:
      branch: ${{ github.ref_name }}

  deploy:
    needs: build
    uses: ./.github/workflows/terraform-deploy.yml
    secrets: inherit
    with:
      branch: ${{ github.ref_name }}

  dbt-metabase-sync:
    needs:
      - deploy
      - detect-changes
    if: ${{ needs.detect-changes.outputs.analytics == 'true' }}
    uses: ./.github/workflows/dbt-metabase-sync.yml
    secrets: inherit
