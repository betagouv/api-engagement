generator client_core {
  provider = "prisma-client-js"
  output   = "../../src/db/core"
}

datasource db_core {
  provider = "postgresql"
  url      = env("DATABASE_URL_CORE")
}

enum StatEventType {
  click
  print
  apply
  account
}

enum StatSource {
  api
  widget
  campaign
  seo
  jstag
  publisher
}

enum StatEventStatus {
  PENDING
  VALIDATED
  CANCEL
  CANCELED
  REFUSED
  CARRIED_OUT
}

model StatEvent {
  id                          String      @id @default(uuid())
  es_id                       String?     @unique
  type                        StatEventType
  created_at                  DateTime    @default(now())
  click_user                  String?
  click_id                    String?
  request_id                  String?
  origin                      String
  referer                     String
  user_agent                  String
  host                        String
  user                        String?
  is_bot                      Boolean
  is_human                    Boolean
  source                      StatSource
  source_id                   String
  source_name                 String
  status                      StatEventStatus

  from_publisher_id           String
  from_publisher_name         String
  to_publisher_id             String
  to_publisher_name           String

  // Mission fields. Should be replaced by foreign keys to existing models when migrated
  mission_id                  String?
  mission_client_id           String?
  mission_domain              String?
  mission_title               String?
  mission_postal_code         String?
  mission_department_name     String?
  mission_organization_id     String?
  mission_organization_name   String?
  mission_organization_client_id String?
  tag                         String?
  tags                        String[]
  export_to_analytics         String?

  @@index([type, created_at], map: "stats_event_type_created_at_desc_idx")
  @@index([mission_id, created_at], map: "stats_event_mission_id_created_at_idx")
  @@index([mission_client_id, created_at], map: "stats_event_mission_client_id_created_at_idx")
  @@index([mission_department_name, created_at], map: "stats_event_mission_department_name_created_at_idx")
  @@index([mission_domain, created_at], map: "stats_event_mission_domain_created_at_idx")
  @@index([tags], type: Gin, map: "stats_event_tags_idx")
  @@index([from_publisher_id, type, created_at], map: "stats_event_from_publisher_type_created_at_idx")
  @@index([to_publisher_id, type, created_at], map: "stats_event_to_publisher_type_created_at_idx")
}