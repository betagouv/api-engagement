generator client_core {
  provider = "prisma-client-js"
  output   = "../../src/db/core"
}

datasource db_core {
  provider = "postgresql"
  url      = env("DATABASE_URL_CORE")
}

//
// Enums
//
enum EmailStatus {
  PENDING
  PROCESSED
  DUPLICATE
  FAILED
}

enum ImportStatus {
  SUCCESS
  FAILED
}

enum ReportDataTemplate {
  BOTH
  RECEIVED
  SENT
}

enum MissionType {
  benevolat
  volontariat_service_civique
}

enum MissionEventType {
  create
  update
  delete
}

enum StatEventType {
  click
  print
  apply
  account
}

enum StatSource {
  api
  widget
  campaign
  seo
  jstag
  publisher
}

enum StatEventStatus {
  PENDING
  VALIDATED
  CANCEL
  CANCELED
  REFUSED
  CARRIED_OUT
}

enum ModerationEventStatus {
  ACCEPTED
  REFUSED
  PENDING
  ONGOING
}

//
// Models
//
model Email {
  id             String      @id @default(uuid())
  messageId      String?     @map("message_id")
  inReplyTo      String?     @map("in_reply_to")
  fromName       String?     @map("from_name")
  fromEmail      String?     @map("from_email")
  to             Json?
  toEmails       String[]    @default([]) @map("to_emails")
  subject        String?     @map("subject")
  sentAt         DateTime?   @map("sent_at")
  rawTextBody    String?     @map("raw_text_body")
  rawHtmlBody    String?     @map("raw_html_body")
  mdTextBody     String?     @map("md_text_body")
  attachments    Json?
  raw            Json?
  status         EmailStatus @default(PENDING)
  reportUrl      String?     @map("report_url")
  fileObjectName String?     @map("file_object_name")
  dateFrom       DateTime?   @map("date_from")
  dateTo         DateTime?   @map("date_to")
  createdCount   Int?        @map("created_count")
  failed         Json?
  deletedAt      DateTime?   @map("deleted_at")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  @@index([status], map: "email_status_idx")
  @@index([dateFrom, dateTo], map: "email_date_from_to_idx")
  @@index([toEmails], type: Gin, map: "email_to_emails_idx")
  @@map("email")
}

model Report {
  id           String              @id @default(uuid())
  name         String
  month        Int
  year         Int
  url          String
  objectName   String?             @map("object_name")
  publisherId  String              @map("publisher_id")
  dataTemplate ReportDataTemplate? @map("data_template")
  sentAt       DateTime?           @map("sent_at")
  sentTo       String[]            @map("sent_to")
  status       String
  data         Json
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  publisher Publisher @relation("PublisherReportRelation", fields: [publisherId], references: [id])

  @@unique([publisherId, month, year], map: "report_publisher_id_month_year_key")
  @@index([publisherId], map: "report_publisher_id_idx")
  @@map("report")
}

model StatEvent {
  id                String          @id @default(uuid())
  esId              String?         @unique @map("es_id")
  type              StatEventType
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime?       @updatedAt @map("updated_at")
  clickUser         String?         @map("click_user")
  clickId           String?         @map("click_id")
  requestId         String?         @map("request_id")
  origin            String
  referer           String
  userAgent         String          @map("user_agent")
  host              String
  user              String?
  isBot             Boolean         @map("is_bot")
  isHuman           Boolean         @map("is_human")
  source            StatSource
  sourceId          String          @map("source_id")
  sourceName        String          @map("source_name")
  customAttributes  Json?           @map("custom_attributes")
  status            StatEventStatus

  fromPublisherId   String          @map("from_publisher_id")
  toPublisherId     String          @map("to_publisher_id")

  fromPublisher Publisher @relation("StatEventFromPublisher", fields: [fromPublisherId], references: [id])
  toPublisher   Publisher @relation("StatEventToPublisher", fields: [toPublisherId], references: [id])

  // Mission fields. Should be replaced by foreign keys to existing models when migrated
  missionId                     String? @map("mission_id")
  missionClientId               String? @map("mission_client_id")
  missionDomain                 String? @map("mission_domain")
  missionTitle                  String? @map("mission_title")
  missionPostalCode             String? @map("mission_postal_code")
  missionDepartmentName         String? @map("mission_department_name")
  missionOrganizationId         String? @map("mission_organization_id")
  missionOrganizationName       String? @map("mission_organization_name")
  missionOrganizationClientId   String? @map("mission_organization_client_id")
  tag                           String?
  tags                          String[] @default([])
  exportToAnalytics             String? @map("export_to_analytics")

  @@index([type, createdAt], map: "stats_event_type_created_at_desc_idx")
  @@index([missionId, createdAt], map: "stats_event_mission_id_created_at_idx")
  @@index([missionClientId, createdAt], map: "stats_event_mission_client_id_created_at_idx")
  @@index([missionDepartmentName, createdAt], map: "stats_event_mission_department_name_created_at_idx")
  @@index([missionDomain, createdAt], map: "stats_event_mission_domain_created_at_idx")
  @@index([tags], type: Gin, map: "stats_event_tags_idx")
  @@index([fromPublisherId, createdAt(sort: Desc)], map: "stats_event_from_publisher_created_at_idx")
  @@index([toPublisherId, createdAt(sort: Desc)], map: "stats_event_to_publisher_created_at_idx")
  @@index([fromPublisherId, type, createdAt], map: "stats_event_from_publisher_type_created_at_idx")
  @@index([toPublisherId, type, createdAt], map: "stats_event_to_publisher_type_created_at_idx")
  @@index([updatedAt(sort: Asc)], map: "stats_event_updated_at_asc_idx")
  @@index([user], map: "stats_event_user_idx")

  @@map("stat_event")
}

model ModerationEvent {
  id             String                 @id @default(uuid())
  missionId      String                 @map("mission_id")
  moderatorId    String                 @map("moderator_id")
  userId         String?                @map("user_id")
  userName       String?                @map("user_name")
  initialStatus  ModerationEventStatus? @map("initial_status")
  newStatus      ModerationEventStatus? @map("new_status")
  initialComment String?                @map("initial_comment")
  newComment     String?                @map("new_comment")
  initialNote    String?                @map("initial_note")
  newNote        String?                @map("new_note")
  initialTitle   String?                @map("initial_title")
  newTitle       String?                @map("new_title")
  initialSiren   String?                @map("initial_siren")
  newSiren       String?                @map("new_siren")
  initialRNA     String?                @map("initial_rna")
  newRNA         String?                @map("new_rna")
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")

  @@index([updatedAt(sort: Asc)], map: "moderation_event_updated_at_idx")
  @@index([missionId], map: "moderation_event_mission_id_idx")
  @@index([moderatorId], map: "moderation_event_moderator_id_idx")
  @@index([userId], map: "moderation_event_user_id_idx")
  @@map("moderation_event")
}

model Publisher {
  id                 String       @id @default(uuid())
  name               String
  category           String?      @map("category")
  url                String?      @map("url")
  moderator          Boolean      @default(false) @map("moderator")
  moderatorLink      String?      @map("moderator_link")
  email              String?      @map("email")
  documentation      String?      @map("documentation")
  logo               String?      @map("logo")
  defaultMissionLogo String?      @map("default_mission_logo")
  lead               String?      @map("lead")
  feed               String?      @map("feed")
  feedUsername       String?      @map("feed_username")
  feedPassword       String?      @map("feed_password")
  apikey             String?      @map("apikey")
  description        String       @default("") @map("description")
  missionType        MissionType? @map("mission_type")
  isAnnonceur        Boolean      @default(false) @map("is_annonceur")
  hasApiRights       Boolean      @default(false) @map("has_api_rights")
  hasWidgetRights    Boolean      @default(false) @map("has_widget_rights")
  hasCampaignRights  Boolean      @default(false) @map("has_campaign_rights")
  sendReport         Boolean      @default(false) @map("send_report")
  sendReportTo       String[]     @default([]) @map("send_report_to")
  deletedAt          DateTime?    @map("deleted_at")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  diffuseurs            PublisherDiffusion[] @relation("PublisherAnnonceurRelation")
  diffusionsAsDiffuseur PublisherDiffusion[] @relation("PublisherDiffuseurRelation")
  warnings              Warning[]            @relation("WarningPublisherRelation")
  imports               Import[]             @relation("ImportPublisherRelation")
  reports               Report[]             @relation("PublisherReportRelation")
  statEventsFrom        StatEvent[]          @relation("StatEventFromPublisher")
  statEventsTo          StatEvent[]          @relation("StatEventToPublisher")

  @@index([name], map: "publisher_name_idx")
  @@index([apikey], map: "publisher_apikey_idx")
  @@index([missionType], map: "publisher_mission_type_idx")
  @@index([deletedAt], map: "publisher_deleted_at_idx")
  @@index([isAnnonceur], map: "publisher_is_annonceur_idx")
  @@index([hasApiRights], map: "publisher_has_api_rights_idx")
  @@index([hasWidgetRights], map: "publisher_has_widget_rights_idx")
  @@index([hasCampaignRights], map: "publisher_has_campaign_rights_idx")
  @@index([sendReport], map: "publisher_send_report_idx")
  @@map("publisher")
}

model PublisherDiffusion {
  id                   String       @id @default(uuid())
  diffuseurPublisherId String       @map("diffuseur_publisher_id")
  annonceurPublisherId String       @map("annonceur_publisher_id")
  moderator            Boolean      @default(false) @map("moderator")
  missionType          MissionType? @map("mission_type")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  diffuseur Publisher @relation("PublisherDiffuseurRelation", fields: [diffuseurPublisherId], references: [id], onDelete: Cascade)
  annonceur Publisher @relation("PublisherAnnonceurRelation", fields: [annonceurPublisherId], references: [id], onDelete: Cascade)

  @@index([diffuseurPublisherId], map: "publisher_diffusion_diffuseur_id_idx")
  @@index([annonceurPublisherId], map: "publisher_diffusion_annonceur_id_idx")
  @@map("publisher_diffusion")
}

model Warning {
  id          String    @id @default(uuid())
  type        String
  title       String?
  description String?
  publisherId String    @map("publisher_id")
  seen        Boolean   @default(false)
  fixed       Boolean   @default(false)
  fixedAt     DateTime? @map("fixed_at")
  occurrences Int       @default(1)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  publisher Publisher @relation("WarningPublisherRelation", fields: [publisherId], references: [id], onDelete: Cascade)

  @@index([publisherId], map: "warning_publisher_id_idx")
  @@index([type], map: "warning_type_idx")
  @@index([fixed], map: "warning_fixed_idx")
  @@index([createdAt], map: "warning_created_at_idx")
  @@map("warning")
}

model Import {
  id           String       @id @default(uuid())
  name         String
  publisherId  String       @map("publisher_id")
  missionCount Int          @default(0) @map("mission_count")
  refusedCount Int          @default(0) @map("refused_count")
  createdCount Int          @default(0) @map("created_count")
  deletedCount Int          @default(0) @map("deleted_count")
  updatedCount Int          @default(0) @map("updated_count")
  startedAt    DateTime?    @map("started_at")
  finishedAt   DateTime?    @map("finished_at")
  status       ImportStatus @default(SUCCESS) @map("status")
  error        String?      @map("error")
  failed       Json?        @map("failed")

  publisher Publisher @relation("ImportPublisherRelation", fields: [publisherId], references: [id], onDelete: Cascade)

  @@index([publisherId], map: "import_publisher_id_idx")
  @@index([startedAt], map: "import_started_at_idx")
  @@index([status], map: "import_status_idx")
  @@index([publisherId, startedAt(sort: Desc)], map: "import_publisher_started_at_desc_idx")
  @@map("import")
}

model MissionEvent {
  id        String           @id @default(uuid())
  missionId String           @map("mission_id")
  type      MissionEventType
  changes   Json?
  createdBy String?          @map("created_by")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  @@index([missionId], map: "mission_event_mission_id_idx")
  @@index([updatedAt(sort: Asc)], map: "mission_event_updated_at_asc_idx")
  @@map("mission_event")
}

model Organization {
  id                     String    @id
  rna                    String?   @unique
  siren                  String?
  siret                  String?
  sirets                 String[]  @default([])
  rupMi                  String?   @map("rup_mi")
  gestion                String?
  status                 String?
  createdAt              DateTime  @default(now()) @map("created_at")
  lastDeclaredAt         DateTime? @map("last_declared_at")
  publishedAt            DateTime? @map("published_at")
  dissolvedAt            DateTime? @map("dissolved_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  nature                 String?
  groupement             String?
  title                  String
  names                  String[]  @default([])
  shortTitle             String?   @map("short_title")
  titleSlug              String?   @map("title_slug")
  shortTitleSlug         String?   @map("short_title_slug")
  object                 String?
  socialObject1          String?   @map("social_object1")
  socialObject2          String?   @map("social_object2")
  addressComplement      String?   @map("address_complement")
  addressNumber          String?   @map("address_number")
  addressRepetition      String?   @map("address_repetition")
  addressType            String?   @map("address_type")
  addressStreet          String?   @map("address_street")
  addressDistribution    String?   @map("address_distribution")
  addressInseeCode       String?   @map("address_insee_code")
  addressPostalCode      String?   @map("address_postal_code")
  addressDepartmentCode  String?   @map("address_department_code")
  addressDepartmentName  String?   @map("address_department_name")
  addressRegion          String?   @map("address_region")
  addressCity            String?   @map("address_city")
  managementDeclarant    String?   @map("management_declarant")
  managementComplement   String?   @map("management_complement")
  managementStreet       String?   @map("management_street")
  managementDistribution String?   @map("management_distribution")
  managementPostalCode   String?   @map("management_postal_code")
  managementCity         String?   @map("management_city")
  managementCountry      String?   @map("management_country")
  directorCivility       String?   @map("director_civility")
  website                String?
  observation            String?
  syncAt                 DateTime? @map("sync_at")
  source                 String?
  isRUP                  Boolean   @default(false) @map("is_rup")
  letudiantPublicId      String?   @map("letudiant_public_id")
  letudiantUpdatedAt     DateTime? @map("letudiant_updated_at")
  lastExportedToPgAt     DateTime? @map("last_exported_to_pg_at")

  @@index([updatedAt, lastExportedToPgAt], map: "organization_updated_last_exported_idx")
  @@index([rna(ops: raw("gin_trgm_ops"))], type: Gin, map: "organization_rna_idx")
  @@index([title(ops: raw("gin_trgm_ops"))], type: Gin, map: "organization_title_idx")
  @@index([shortTitle(ops: raw("gin_trgm_ops"))], type: Gin, map: "organization_short_title_idx")
  @@index([object(ops: raw("gin_trgm_ops"))], type: Gin, map: "organization_object_idx")
  @@index([titleSlug], map: "organization_title_slug_idx")
  @@index([siret(ops: raw("gin_trgm_ops"))], type: Gin, map: "organization_siret_idx")
  @@index([sirets], type: Gin, map: "organization_sirets_idx")
  @@index([siren(ops: raw("gin_trgm_ops"))], type: Gin, map: "organization_siren_idx")
  @@index([names], type: Gin, map: "organization_names_idx")
  @@index([addressDepartmentName], map: "organization_department_name_idx")
  @@index([addressCity], map: "organization_city_idx")
  @@map("organization")
}
