generator client_core {
  provider = "prisma-client-js"
  output   = "../../src/db/core"
}

datasource db_core {
  provider = "postgresql"
  url      = env("DATABASE_URL_CORE")
}

//
// Enums
//
enum EmailStatus {
  PENDING
  PROCESSED
  DUPLICATE
  FAILED
}

enum ReportDataTemplate {
  BOTH
  RECEIVED
  SENT
}

enum MissionType {
  benevolat
  volontariat_service_civique
}

enum StatEventType {
  click
  print
  apply
  account
}

enum StatSource {
  api
  widget
  campaign
  seo
  jstag
  publisher
}

enum StatEventStatus {
  PENDING
  VALIDATED
  CANCEL
  CANCELED
  REFUSED
  CARRIED_OUT
}

//
// Models
//
model Email {
  id             String      @id @default(uuid())
  messageId      String?     @map("message_id")
  inReplyTo      String?     @map("in_reply_to")
  fromName       String?     @map("from_name")
  fromEmail      String?     @map("from_email")
  to             Json?
  toEmails       String[]    @default([]) @map("to_emails")
  subject        String?     @map("subject")
  sentAt         DateTime?   @map("sent_at")
  rawTextBody    String?     @map("raw_text_body")
  rawHtmlBody    String?     @map("raw_html_body")
  mdTextBody     String?     @map("md_text_body")
  attachments    Json?
  raw            Json?
  status         EmailStatus @default(PENDING)
  reportUrl      String?     @map("report_url")
  fileObjectName String?     @map("file_object_name")
  dateFrom       DateTime?   @map("date_from")
  dateTo         DateTime?   @map("date_to")
  createdCount   Int?        @map("created_count")
  failed         Json?
  deletedAt      DateTime?   @map("deleted_at")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  @@index([status], map: "email_status_idx")
  @@index([dateFrom, dateTo], map: "email_date_from_to_idx")
  @@index([toEmails], type: Gin, map: "email_to_emails_idx")
  @@map("email")
}

model Report {
  id            String              @id @default(uuid())
  name          String
  month         Int
  year          Int
  url           String
  objectName    String?             @map("object_name")
  publisherId   String              @map("publisher_id")
  publisherName String              @map("publisher_name") // TODO: remove when Publisher PR is merged
  dataTemplate  ReportDataTemplate? @map("data_template")
  sentAt        DateTime?           @map("sent_at")
  sentTo        String[]            @map("sent_to")
  status        String
  data          Json

  @@unique([publisherId, month, year], map: "report_publisher_id_month_year_key")
  @@map("report")
}

model StatEvent {
  id                String          @id @default(uuid())
  es_id             String?         @unique
  type              StatEventType
  created_at        DateTime        @default(now())
  updated_at        DateTime?       @updatedAt
  click_user        String?
  click_id          String?
  request_id        String?
  origin            String
  referer           String
  user_agent        String
  host              String
  user              String?
  is_bot            Boolean
  is_human          Boolean
  source            StatSource
  source_id         String
  source_name       String
  custom_attributes Json?
  status            StatEventStatus

  from_publisher_id   String
  from_publisher_name String
  to_publisher_id     String
  to_publisher_name   String

  // Mission fields. Should be replaced by foreign keys to existing models when migrated
  mission_id                     String?
  mission_client_id              String?
  mission_domain                 String?
  mission_title                  String?
  mission_postal_code            String?
  mission_department_name        String?
  mission_organization_id        String?
  mission_organization_name      String?
  mission_organization_client_id String?
  tag                            String?
  tags                           String[]
  export_to_analytics            String?

  @@index([type, created_at], map: "stats_event_type_created_at_desc_idx")
  @@index([mission_id, created_at], map: "stats_event_mission_id_created_at_idx")
  @@index([mission_client_id, created_at], map: "stats_event_mission_client_id_created_at_idx")
  @@index([mission_department_name, created_at], map: "stats_event_mission_department_name_created_at_idx")
  @@index([mission_domain, created_at], map: "stats_event_mission_domain_created_at_idx")
  @@index([tags], type: Gin, map: "stats_event_tags_idx")
  @@index([from_publisher_id, created_at], map: "stats_event_from_publisher_created_at_idx")
  @@index([to_publisher_id, created_at], map: "stats_event_to_publisher_created_at_idx")
  @@index([from_publisher_id, type, created_at], map: "stats_event_from_publisher_type_created_at_idx")
  @@index([to_publisher_id, type, created_at], map: "stats_event_to_publisher_type_created_at_idx")
  @@index([updated_at(sort: Asc)], map: "stats_event_updated_at_asc_idx")
}

model Publisher {
  id                 String       @id @default(uuid())
  name               String
  category           String?      @map("category")
  url                String?      @map("url")
  moderator          Boolean      @default(false) @map("moderator")
  moderatorLink      String?      @map("moderator_link")
  email              String?      @map("email")
  documentation      String?      @map("documentation")
  logo               String?      @map("logo")
  defaultMissionLogo String?      @map("default_mission_logo")
  lead               String?      @map("lead")
  feed               String?      @map("feed")
  feedUsername       String?      @map("feed_username")
  feedPassword       String?      @map("feed_password")
  apikey             String?      @map("apikey")
  description        String       @default("") @map("description")
  missionType        MissionType? @map("mission_type")
  isAnnonceur        Boolean      @default(false) @map("is_annonceur")
  hasApiRights       Boolean      @default(false) @map("has_api_rights")
  hasWidgetRights    Boolean      @default(false) @map("has_widget_rights")
  hasCampaignRights  Boolean      @default(false) @map("has_campaign_rights")
  sendReport         Boolean      @default(false) @map("send_report")
  sendReportTo       String[]     @default([]) @map("send_report_to")
  deletedAt          DateTime?    @map("deleted_at")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  diffuseurs            PublisherDiffusion[] @relation("PublisherAnnonceurRelation")
  diffusionsAsDiffuseur PublisherDiffusion[] @relation("PublisherDiffuseurRelation")

  @@index([name], map: "publisher_name_idx")
  @@index([apikey], map: "publisher_apikey_idx")
  @@index([missionType], map: "publisher_mission_type_idx")
  @@index([deletedAt], map: "publisher_deleted_at_idx")
  @@index([isAnnonceur], map: "publisher_is_annonceur_idx")
  @@index([hasApiRights], map: "publisher_has_api_rights_idx")
  @@index([hasWidgetRights], map: "publisher_has_widget_rights_idx")
  @@index([hasCampaignRights], map: "publisher_has_campaign_rights_idx")
  @@index([sendReport], map: "publisher_send_report_idx")
  @@map("publisher")
}

model PublisherDiffusion {
  id                   String       @id @default(uuid())
  diffuseurPublisherId String       @map("diffuseur_publisher_id")
  annonceurPublisherId String       @map("annonceur_publisher_id")
  moderator            Boolean      @default(false) @map("moderator")
  missionType          MissionType? @map("mission_type")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  diffuseur Publisher @relation("PublisherDiffuseurRelation", fields: [diffuseurPublisherId], references: [id], onDelete: Cascade)
  annonceur Publisher @relation("PublisherAnnonceurRelation", fields: [annonceurPublisherId], references: [id], onDelete: Cascade)

  @@index([diffuseurPublisherId], map: "publisher_diffusion_diffuseur_id_idx")
  @@index([annonceurPublisherId], map: "publisher_diffusion_annonceur_id_idx")
  @@map("publisher_diffusion")
}
