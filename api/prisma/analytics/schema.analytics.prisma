generator client_analytics {
  provider = "prisma-client-js"
  output   = "../../src/db/analytics"
}

datasource db_analytics {
  provider = "postgresql"
  url      = env("DATABASE_URL_ANALYTICS")
}

model Account {
  id              String      @id @default(uuid())
  old_id          String      @unique
  stat_event_id   String?
  mission_id      String?
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  campaign_id     String?
  widget_id       String?
  source          SourceType?
  url             String?
  from_partner_id String?
  to_partner_id   String?
  old_view_id     String?
  click_id        String?
  source_id       String?
  host            String?
  tag             String?
  mission_old_id  String?
  campaign        Campaign?   @relation(fields: [campaign_id], references: [id])
  click           Click?      @relation(fields: [click_id], references: [id])
  from_partner    Partner?    @relation("FromAccount", fields: [from_partner_id], references: [id])
  mission         Mission?    @relation(fields: [mission_id], references: [id])
  to_partner      Partner?    @relation("ToAccount", fields: [to_partner_id], references: [id])

  @@index([mission_id], map: "account_mission_id")
  @@index([campaign_id], map: "account_campaign_id")
  @@index([widget_id], map: "account_widget_id")
  @@index([from_partner_id], map: "account_from_partner_id")
  @@index([to_partner_id], map: "account_to_partner_id")
}

model Apply {
  id                String      @id @default(uuid())
  old_id            String      @unique
  stat_event_id     String?
  mission_id        String?
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt
  campaign_id       String?
  widget_id         String?
  source            SourceType?
  host              String?
  from_partner_id   String?
  to_partner_id     String?
  tag               String?
  status            String?
  old_view_id       String?
  click_id          String?
  source_id         String?
  mission_old_id    String?
  custom_attributes Json?
  campaign          Campaign?   @relation(fields: [campaign_id], references: [id])
  click             Click?      @relation(fields: [click_id], references: [id])
  from_partner      Partner?    @relation("FromApply", fields: [from_partner_id], references: [id])
  mission           Mission?    @relation(fields: [mission_id], references: [id])
  to_partner        Partner?    @relation("ToApply", fields: [to_partner_id], references: [id])

  @@index([mission_id], map: "apply_mission_id")
  @@index([campaign_id], map: "apply_campaign_id")
  @@index([widget_id], map: "apply_widget_id")
  @@index([from_partner_id], map: "apply_from_partner_id")
  @@index([to_partner_id], map: "apply_to_partner_id")
}

model Campaign {
  id                      String    @id @default(uuid())
  url                     String?
  old_id                  String    @unique
  name                    String?
  diffuseur_id            String
  annonceur_id            String
  active                  Boolean   @default(true)
  deleted_at              DateTime?
  created_at              DateTime  @default(now())
  updated_at              DateTime  @default(now())
  reassigned_at           DateTime?
  reassigned_by_user_id   String?
  reassigned_by_user_name String?
  type                    String?

  accounts    Account[]
  applies     Apply[]
  annonceur   Partner           @relation("AnnonceurCampaign", fields: [annonceur_id], references: [id])
  diffuseur   Partner           @relation("DiffuseurCampaign", fields: [diffuseur_id], references: [id])
  clicks      Click[]
  impressions Impression[]
  trackers    CampaignTracker[]

  @@index([diffuseur_id], map: "campaign_diffuseur_id")
  @@index([annonceur_id], map: "campaign_annonceur_id")
}

model CampaignTracker {
  id          String @id @default(uuid())
  campaign_id String
  key         String
  value       String

  campaign Campaign @relation(fields: [campaign_id], references: [id], onDelete: Cascade)

  @@index([campaign_id], map: "campaign_tracker_campaign_id")
}

model Click {
  id              String      @id @default(uuid())
  old_id          String      @unique
  stat_event_id   String?
  mission_id      String?
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  campaign_id     String?
  widget_id       String?
  source          SourceType?
  url_origin      String?
  from_partner_id String?
  to_partner_id   String?
  tag             String?
  tags            String[]
  source_id       String?
  mission_old_id  String?
  accounts        Account[]
  applies         Apply[]
  is_bot          Boolean     @default(false)
  is_human        Boolean     @default(false)
  campaign        Campaign?   @relation(fields: [campaign_id], references: [id])
  from_partner    Partner?    @relation("FromClick", fields: [from_partner_id], references: [id])
  mission         Mission?    @relation(fields: [mission_id], references: [id])
  to_partner      Partner?    @relation("ToClick", fields: [to_partner_id], references: [id])

  @@index([mission_id], map: "click_mission_id")
  @@index([campaign_id], map: "click_campaign_id")
  @@index([widget_id], map: "click_widget_id")
  @@index([from_partner_id], map: "click_from_partner_id")
  @@index([to_partner_id], map: "click_to_partner_id")
}

model Impression {
  id              String      @id @default(uuid())
  stat_event_id   String?
  mission_id      String?
  to_partner_id   String?
  from_partner_id String?
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  campaign_id     String?
  widget_id       String?
  host            String?
  source          SourceType?
  source_id       String?
  old_id          String      @unique
  mission_old_id  String?
  campaign        Campaign?   @relation(fields: [campaign_id], references: [id])
  from_partner    Partner?    @relation("FromImpression", fields: [from_partner_id], references: [id])
  mission         Mission?    @relation(fields: [mission_id], references: [id])
  to_partner      Partner?    @relation("ToImpression", fields: [to_partner_id], references: [id])

  @@index([mission_id], map: "impression_mission_id")
  @@index([to_partner_id], map: "impression_to_partner_id")
  @@index([from_partner_id], map: "impression_from_partner_id")
  @@index([campaign_id], map: "impression_campaign_id")
}

model Mission {
  id              String    @id @default(uuid())
  title           String?
  old_id          String    @unique
  // Address
  address         String?
  department_name String?
  department_code String?
  city            String?
  postal_code     String?
  country         String?
  region          String?
  latitude        Float?
  longitude       Float?
  geoloc_status   String?
  addresses       Address[]

  domain                        String
  domain_logo                   String?
  activity                      String?
  partner_id                    String?
  application_url               String?
  description                   String?
  type                          MissionType?
  duration                      Int?
  deleted_at                    DateTime?
  open_to_minors                String?
  organization_actions          String[]
  organization_beneficiaries    String[]
  organization_city             String?
  organization_description      String?
  organization_logo             String?
  organization_name             String?
  organization_rna              String?
  organization_reseaux          String[]
  organization_siren            String?
  organization_status_juridique String?
  organization_url              String?
  organization_full_address     String?
  schedule                      String?
  remote                        String?
  last_sync_at                  DateTime?    @default(now())
  status                        String?
  status_comment                String?
  posted_at                     DateTime?    @default(now())
  close_to_transport            String?
  reduced_mobility_accessible   String?
  start_at                      DateTime?    @default(now())
  end_at                        DateTime?    @default(now())
  created_at                    DateTime     @default(now())
  updated_at                    DateTime     @updatedAt
  audience                      String[]
  rna_status                    String?
  snu                           Boolean?
  snu_places                    Int?
  tags                          String[]

  compensation_amount Float?
  compensation_unit   String?
  compensation_type   String?

  jva_moderation_comment    String?
  jva_moderation_status     String?
  jva_moderation_title      String?
  jva_moderation_user_id    String?
  jva_moderation_updated_at DateTime?

  organization_client_id                String?
  organization_department               String?
  client_id                             String?
  description_html                      String?
  leboncoin_moderation_comment          String?
  leboncoin_moderation_status           String?
  leboncoin_moderation_updated_at       DateTime?
  leboncoin_moderation_url              String?
  metadata                              String?
  organization_postal_code              String?
  priority                              String?
  soft_skills                           String[]
  rome_skills                           String[]
  requirements                          String[]
  tasks                                 String[]
  places                                Int?
  places_status                         String?
  matched_organization_id               String?
  organization_verification_status      String?
  organization_name_verified            String?
  organization_rna_verified             String?
  organization_siren_verified           String?
  organization_siret_verified           String?
  organization_address_verified         String?
  organization_city_verified            String?
  organization_postal_code_verified     String?
  organization_department_code_verified String?
  organization_department_name_verified String?
  organization_region_verified          String?
  is_siren_verified                     Boolean?
  is_siret_verified                     Boolean?
  is_rna_verified                       Boolean?

  accounts       Account[]
  applies        Apply[]
  clicks         Click[]
  impressions    Impression[]
  organization   Organization?         @relation(fields: [matched_organization_id], references: [id])
  partner        Partner?              @relation(fields: [partner_id], references: [id])
  history_events MissionHistoryEvent[] @relation("MissionHistoryEvent")

  @@index([client_id], map: "mission_client_id")
  @@index([matched_organization_id], map: "mission_matched_organization_id")
  @@index([partner_id], map: "mission_partner_id")
  @@index([old_id], map: "mission_old_id")
}

model Address {
  id              String  @id @default(uuid())
  old_id          String
  street          String?
  city            String?
  postal_code     String?
  country         String?
  department_code String?
  department_name String?
  region          String?
  latitude        Float?
  longitude       Float?
  geoloc_status   String  @default("NOT_FOUND")
  mission_id      String
  mission         Mission @relation(fields: [mission_id], references: [id], onDelete: Cascade)

  @@unique([mission_id, old_id], map: "address_mission_id_old_id")
  @@index([mission_id], map: "address_mission_id")
  @@index([old_id], map: "address_old_id")
}

model Organization {
  id                      String    @id @default(uuid())
  old_id                  String    @unique
  rna                     String?
  siren                   String?
  siret                   String?
  rup_mi                  String?
  gestion                 String?
  status                  String?
  created_at              DateTime  @default(now())
  last_declared_at        DateTime?
  published_at            DateTime?
  dissolved_at            DateTime?
  updated_at              DateTime
  nature                  String?
  groupement              String?
  title                   String
  short_title             String?
  title_slug              String
  short_title_slug        String?
  names                   String[]
  object                  String?
  social_object1          String?
  social_object2          String?
  address_complement      String?
  address_number          String?
  address_repetition      String?
  address_type            String?
  address_street          String?
  address_distribution    String?
  address_insee_code      String?
  address_postal_code     String?
  address_department_code String?
  address_department_name String?
  address_region          String?
  address_city            String?
  management_declarant    String?
  management_complement   String?
  management_street       String?
  management_distribution String?
  management_postal_code  String?
  management_city         String?
  management_country      String?
  director_civility       String?
  website                 String?
  observation             String?
  sync_at                 DateTime?
  source                  String?
  missions                Mission[]

  @@index([old_id], map: "organization_old_id")
}

model Partner {
  id     String  @id @default(uuid())
  old_id String  @unique
  name   String?

  diffuseur_api       Boolean
  diffuseur_widget    Boolean
  diffuseur_campaign  Boolean
  annonceur           Boolean
  api_key             String?
  partners            String[]
  created_at          DateTime     @default(now())
  updated_at          DateTime     @updatedAt
  deleted_at          DateTime?
  account_from        Account[]    @relation("FromAccount")
  account_to          Account[]    @relation("ToAccount")
  apply_from          Apply[]      @relation("FromApply")
  apply_to            Apply[]      @relation("ToApply")
  annonceur_campaigns Campaign[]   @relation("AnnonceurCampaign")
  diffuseur_campaigns Campaign[]   @relation("DiffuseurCampaign")
  click_from          Click[]      @relation("FromClick")
  click_to            Click[]      @relation("ToClick")
  impression_from     Impression[] @relation("FromImpression")
  impression_to       Impression[] @relation("ToImpression")
  missions            Mission[]
}

model MissionHistoryEvent {
  id         String                  @id @default(uuid())
  date       DateTime                @default(now())
  type       MissionHistoryEventType
  mission_id String
  mission    Mission?                @relation("MissionHistoryEvent", fields: [mission_id], references: [id])
  changes    Json?

  @@index([mission_id])
}

enum MissionHistoryEventType {
  Created
  Deleted
  UpdatedStartDate
  UpdatedEndDate
  UpdatedDescription
  UpdatedActivityDomain
  UpdatedPlaces
  UpdatedJVAModerationStatus
  UpdatedApiEngModerationStatus
  UpdatedOther
}

enum MissionType {
  benevolat
  volontariat
  volontariat_service_civique
}

enum SourceType {
  api
  widget
  campaign
  seo
  jstag
}
