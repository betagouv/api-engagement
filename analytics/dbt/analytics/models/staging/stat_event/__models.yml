version: 2

models:
  - name: stg_stat_event
    description: >
      Extraction brute de la table `analytics_raw.stat_event`. Ce modèle applique
      uniquement le typage de base (timestamps, booléens) tout en conservant la
      granularité événementielle d’origine avant enrichissements.
    columns:
      - name: id
        description: Identifiant unique de l’événement côté application source.
        tests:
          - not_null
          - unique
      - name: type
        description: Type d’événement collecté (`click`, `apply`, `account`, `print`).
        tests:
          - not_null
      - name: created_at
        description: Horodatage (UTC) de la collecte.
        tests:
          - not_null
      - name: updated_at
        description: Dernière date de mise à jour de la ligne (suit le curseur incrémental).
        tests:
          - not_null
      - name: source
        description: Origine déclarée de l’événement (api, widget, campagne, etc.).
      - name: source_id
        description: Identifiant métier transmis par la source (widget_id, campaign_id…).
      - name: from_publisher_id
        description: Identifiant partenaire « diffuseur » issu de la base core.
      - name: to_publisher_id
        description: Identifiant partenaire « annonceur » issu de la base core.
      - name: mission_id
        description: Identifiant de mission connu côté analytics (peut être nul).
      - name: mission_client_id
        description: Identifiant client de mission (clé métier provenant du diffuseur).
      - name: click_id
        description: Identifiant de clic associé lorsqu’il existe, sinon chaîne vide.
      - name: client_event_id
        description: Identifiant client de l’événement (déduplication côté publisher).

  - name: stg_stat_event__click
    description: >
      Transformation des événements `stat_event` de type `click`. Le modèle enrichit les
      identifiants partenaires, missions et sources pour reproduire la logique du job
      Node `export-stats-to-pg/utils/click.ts`.
    columns:
      - name: stat_event_id
        description: Identifiant source de l’événement.
        tests:
          - not_null
          - unique
      - name: created_at
        description: Horodatage du clic.
        tests:
          - not_null
      - name: from_publisher_id
        description: UUID du partenaire diffuseur (analytics).
        tests:
          - not_null
      - name: to_publisher_id
        description: UUID du partenaire annonceur (analytics).
        tests:
          - not_null
      - name: mission_id
        description: UUID de la mission associée si retrouvée.
      - name: source
        description: Origine normalisée du clic (api/widget/campaign…).
      - name: click_id
        description: Identifiant du clic dans l’entrepôt analytics.

  - name: stg_stat_event__apply
    description: >
      Transformation des événements `stat_event` de type `apply`. Le modèle reproduit
      l’enrichissement métier du job Node pour les candidatures (partenaires, missions,
      sources, statut et attributs personnalisés).
    columns:
      - name: stat_event_id
        description: Identifiant source de l’événement.
        tests:
          - not_null
          - unique
      - name: from_publisher_id
        description: UUID du partenaire diffuseur.
        tests:
          - not_null
      - name: to_publisher_id
        description: UUID du partenaire annonceur.
        tests:
          - not_null
      - name: mission_id
        description: UUID de la mission associée si retrouvée.
      - name: status
        description: Statut métier de la candidature (pending, validated…).
      - name: custom_attributes
        description: Payload JSON d’attributs personnalisés.
      - name: client_event_id
        description: Identifiant client de l’événement.

  - name: stg_stat_event__account
    description: >
      Transformation des événements `stat_event` de type `account` (création de compte).
      On retrouve les identifiants analytics (partenaires, mission, clic, sources)
      alignés sur la table Prisma `Account`.
    columns:
      - name: stat_event_id
        description: Identifiant source de l’événement.
        tests:
          - not_null
          - unique
      - name: from_publisher_id
        description: UUID du partenaire diffuseur.
        tests:
          - not_null
      - name: to_publisher_id
        description: UUID du partenaire annonceur.
        tests:
          - not_null
      - name: mission_id
        description: UUID de la mission associée si retrouvée.
      - name: click_id
        description: Identifiant du clic lié au compte (le cas échéant).
      - name: client_event_id
        description: Identifiant client de l’événement.

  - name: stg_stat_event__print
    description: >
      Transformation des événements `stat_event` de type `print`. Ce modèle produit les
      colonnes attendues par la table Prisma `Impression`, y compris la normalisation
      de la source et le mapping des partenaires/missions.
    columns:
      - name: stat_event_id
        description: Identifiant source de l’événement.
        tests:
          - not_null
          - unique
      - name: from_publisher_id
        description: UUID du partenaire diffuseur.
        tests:
          - not_null
      - name: to_publisher_id
        description: UUID du partenaire annonceur.
        tests:
          - not_null
      - name: mission_id
        description: UUID de la mission associée si retrouvée.
      - name: source
        description: Origine normalisée de l’impression (api/widget/campaign…).
