version: 2

models:
  - name: mission
    description: >
      Mart des missions construit à partir de `int_mission`. Il enrichit les identifiants bruts
      avec les libellés de domaine/activité, expose le statut, les attributs d'accessibilité
      et les curseurs temporels nécessaires pour les analyses incrémentales.
    columns:
      - name: id
        description: Identifiant unique de la mission.
        tests:
          - not_null
          - unique
      - name: client_id
        description: Identifiant métier côté client/source.
      - name: publisher_id
        description: Identifiant du partenaire/publisher associé à la mission.
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: organization_id
        description: Identifiant de l'organization associé à la mission.
        tests:
          - relationships:
              arguments:
                to: ref('organization')
                field: id
      - name: organization_client_id
        description: Identifiant client de l'organisation côté diffuseur (nullable).
      - name: activity
        description: Libellé de l'activité (référentiel).
      - name: domain_original
        description: Libellé de domaine original.
      - name: title
        description: Titre de la mission.
      - name: description
        description: Description de la mission.
      - name: type
        description: Type de mission.
      - name: status_code
        description: Code de statut brut.
      - name: compensation_amount
        description: Montant de la compensation (nullable).
      - name: compensation_type
        description: Type de compensation (nullable).
      - name: compensation_unit
        description: Unité de compensation (nullable).
      - name: status
        description: Statut métier de la mission.
      - name: priority
        description: Priorité de la mission (nullable).
      - name: tags
        description: Tags libres associés à la mission.
      - name: tasks
        description: Liste des tâches associées à la mission.
      - name: audience
        description: Publics ciblés par la mission.
      - name: soft_skills
        description: Compétences comportementales associées.
      - name: requirements
        description: Prérequis ou conditions associées.
      - name: rome_skills
        description: Compétences ROME associées.
      - name: reduced_mobility_accessible
        description: Accessibilité aux personnes à mobilité réduite.
      - name: open_to_minors
        description: Indique si la mission est ouverte aux mineurs.
      - name: close_to_transport
        description: Indique si la mission est proche des transports.
      - name: remote
        description: Indique si la mission est réalisable à distance.
      - name: schedule
        description: Informations de planning (nullable).
      - name: duration
        description: Durée de la mission (nullable).
      - name: posted_at
        description: Date de publication initiale.
      - name: start_at
        description: Date de démarrage prévue.
      - name: end_at
        description: Date de fin prévue.
      - name: places
        description: Nombre de places proposées (nullable).
      - name: places_status
        description: Statut des places (nullable).
      - name: deleted_at
        description: Timestamp de suppression logique (nullable).
      - name: created_at
        description: Timestamp de création de la mission.
        tests:
          - not_null
      - name: updated_at
        description: Timestamp de dernière mise à jour de la mission.
        tests:
          - not_null
      - name: domain
        description: Libellé du domaine (référentiel ou libellé original).
      - name: is_deleted
        description: Drapeau booléen dérivé de `deleted_at`.
      - name: organization_name
        description: Nom déclaré de l'organisation (nullable).
      - name: organization_url
        description: URL de référence de l'organisation (nullable).
      - name: organization_type
        description: Typologie déclarée de l'organisation (nullable).
      - name: organization_logo
        description: URL ou identifiant du logo (nullable).
      - name: organization_description
        description: Description libre de l'organisation (nullable).
      - name: organization_full_address
        description: Adresse complète déclarée (nullable).
      - name: organization_rna
        description: Identifiant RNA déclaré (nullable).
      - name: organization_siren
        description: Numéro SIREN déclaré (nullable).
      - name: organization_siret
        description: Numéro SIRET déclaré (nullable).
      - name: organization_department
        description: Département déclaré (libellé, nullable).
      - name: organization_department_code
        description: Code département déclaré (nullable).
      - name: organization_department_name
        description: Nom du département déclaré (nullable).
      - name: organization_post_code
        description: Code postal déclaré (nullable).
      - name: organization_city
        description: Ville déclarée (nullable).
      - name: organization_status_juridique
        description: Statut juridique déclaré (nullable).
      - name: organization_beneficiaries
        description: Liste des bénéficiaires déclarés (nullable).
      - name: organization_actions
        description: Liste des actions déclarées (nullable).
      - name: organization_reseaux
        description: Réseaux déclarés (nullable).
      - name: organization_name_verified
        description: Statut de vérification du nom (nullable).
      - name: organization_rna_verified
        description: Statut de vérification du RNA (nullable).
      - name: organization_siren_verified
        description: Statut de vérification du SIREN (nullable).
      - name: organization_siret_verified
        description: Statut de vérification du SIRET (nullable).
      - name: organization_address_verified
        description: Statut de vérification de l'adresse (nullable).
      - name: organization_city_verified
        description: Statut de vérification de la ville (nullable).
      - name: organization_postal_code_verified
        description: Statut de vérification du code postal (nullable).
      - name: organization_department_code_verified
        description: Statut de vérification du code département (nullable).
      - name: organization_department_name_verified
        description: Statut de vérification du nom de département (nullable).
      - name: organization_region_verified
        description: Statut de vérification de la région (nullable).
      - name: organization_verification_status
        description: Statut de vérification global (nullable).
      - name: organisation_is_rup
        description: Indique si l'organisation est reconnue d'utilité publique (nullable).
  - name: mission_address
    description: >
      Mart des adresses de missions, dérivé du staging `stg_mission_address` pour exposer les localisations associées
      aux missions.
    columns:
      - name: id
        description: Identifiant unique de l'adresse.
        tests:
          - not_null
          - unique
      - name: mission_id
        description: Identifiant de la mission associée.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: street
        description: Voie/adresse déclarée (nullable).
      - name: postal_code
        description: Code postal (nullable).
      - name: department_name
        description: Nom du département (nullable).
      - name: department_code
        description: Code du département (nullable).
      - name: city
        description: Ville déclarée (nullable).
      - name: region
        description: Région déclarée (nullable).
      - name: country
        description: Pays déclaré (nullable).
      - name: location_lat
        description: Latitude géographique (nullable).
      - name: location_lon
        description: Longitude géographique (nullable).
      - name: geo_point
        description: Point géographique (nullable).
  - name: mission_time_to_event_weekly
    description: >
      Mart hebdomadaire des délais (time-to-click/apply) et volumes, agrégé à partir
      de `int_mission_first_events` au grain mission + diffuseur + source.
    columns:
      - name: week_start
        description: Date de début de semaine (lundi) basée sur la création de mission.
        tests:
          - not_null
      - name: year
        description: Année de la semaine.
      - name: week
        description: Numéro de semaine.
      - name: publisher_id
        description: Identifiant du partenaire annonceur de la mission.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: from_publisher_id
        description: Identifiant du diffuseur à l'origine de l'événement (nullable).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: source
        description: Source normalisée (api, widget, campaign).
      - name: source_id
        description: Identifiant de la source (nullable).
      - name: publisher_category
        description: Catégorie de mission (benevolat / volontariat).
      - name: mission_domain
        description: Domaine de la mission.
      - name: mission_activity
        description: Activité de la mission.
      - name: mission_audience
        description: Audience(s) de la mission.
      - name: mission_tags
        description: Tags associés à la mission.
      - name: close_to_transport
        description: Indique si la mission est proche des transports.
      - name: description_length
        description: Nombre de caractères dans la description.
      - name: mission_duration_days
        description: Durée de mission en jours (start_at/end_at).
      - name: mission_count
        description: Nombre de missions distinctes dans le grain.
      - name: mission_with_click_count
        description: Nombre de missions avec au moins un click.
      - name: mission_with_apply_count
        description: Nombre de missions avec au moins une candidature.
      - name: avg_time_to_click_secs
        description: Délai moyen (en secondes) avant premier click.
      - name: avg_time_to_apply_secs
        description: Délai moyen (en secondes) avant première candidature.
      - name: avg_time_to_import_secs
        description: Délai moyen (en secondes) entre posted_at et created_at.
      - name: updated_at
        description: Timestamp de dernière mise à jour propagé depuis les sources.
        tests:
          - not_null
  - name: mission_time_to_event_monthly
    description: >
      Mart mensuel des délais (time-to-click/apply) et volumes, agrégé à partir
      de `int_mission_first_events` au grain mission + diffuseur + source.
    columns:
      - name: month_start
        description: Date de début de mois basée sur la création de mission.
        tests:
          - not_null
      - name: year
        description: Année du mois.
      - name: month
        description: Numéro du mois.
      - name: publisher_id
        description: Identifiant du partenaire annonceur de la mission.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: from_publisher_id
        description: Identifiant du diffuseur à l'origine de l'événement (nullable).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: source
        description: Source normalisée (api, widget, campaign).
      - name: source_id
        description: Identifiant de la source (nullable).
      - name: publisher_category
        description: Catégorie de mission (benevolat / volontariat).
      - name: mission_domain
        description: Domaine de la mission.
      - name: mission_activity
        description: Activité de la mission.
      - name: mission_audience
        description: Audience(s) de la mission.
      - name: mission_tags
        description: Tags associés à la mission.
      - name: close_to_transport
        description: Indique si la mission est proche des transports.
      - name: description_length
        description: Nombre de caractères dans la description.
      - name: mission_duration_days
        description: Durée de mission en jours (start_at/end_at).
      - name: mission_count
        description: Nombre de missions distinctes dans le grain.
      - name: mission_with_click_count
        description: Nombre de missions avec au moins un click.
      - name: mission_with_apply_count
        description: Nombre de missions avec au moins une candidature.
      - name: avg_time_to_click_secs
        description: Délai moyen (en secondes) avant premier click.
      - name: avg_time_to_apply_secs
        description: Délai moyen (en secondes) avant première candidature.
      - name: avg_time_to_import_secs
        description: Délai moyen (en secondes) entre posted_at et created_at.
      - name: updated_at
        description: Timestamp de dernière mise à jour propagé depuis les sources.
        tests:
          - not_null

  - name: mission_active_monthly
    description: >
      Variante mensuelle basée sur `int_mission_active_range` qui déplie les missions actives
      par mois à partir de leur période d'activité (start/end).
    columns:
      - name: year
        description: Année de l’agrégat.
      - name: month
        description: Numéro du mois (1-12).
      - name: month_start
        description: Date de début du mois.
      - name: publisher_category
        description: Catégorie de mission.
      - name: publisher_id
        description: Identifiant du publisher de la mission (nullable).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: mission_count
        description: Missions actives distinctes sur le mois.
  - name: mission_active_department_monthly
    description: >
      Variante mensuelle basée sur `int_mission_active_department_range` pour gérer les missions
      multi-adresses sans déplier en jours.
    columns:
      - name: year
        description: Année de l’agrégat.
      - name: month
        description: Numéro du mois (1-12).
      - name: month_start
        description: Date de début du mois.
      - name: is_all_department
        description: TRUE pour l’agrégat national (tous départements + missions sans département), FALSE pour l’agrégat départemental.
      - name: department
        description: Code département (null pour l’agrégat national ou les missions sans département).
      - name: publisher_id
        description: Identifiant du publisher de la mission (nullable).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: publisher_category
        description: Type de mission (normalisé).
      - name: mission_domain
        description: Domaine de la mission.
      - name: mission_count
        description: Nombre de missions actives distinctes sur le mois et le département.
      - name: max_updated_at
        description: Dernière date de mise à jour observée pour l’agrégat.

  - name: mission_events_yearly
    description: >
      Variante annuelle basée sur les périodes d’activité (start/end) issues des modèles
      range. Les événements sont comptés uniquement lorsque la mission est active à la date
      de l’événement (created_at).
    columns:
      - name: year
        description: Année civile de l’agrégat.
        tests:
          - not_null
      - name: is_all_department
        description: TRUE pour l’agrégat national, FALSE pour l’agrégat départemental.
      - name: department
        description: Code département (null si national).
      - name: mission_domain
        description: Domaine de la mission.
      - name: publisher_category
        description: Catégorie de mission (benevolat / volontariat / all).
      - name: mission_count
        description: Nombre de missions actives dans l’année (distinct mission_id).
      - name: organization_count
        description: Nombre d’organisations distinctes associées aux missions actives dans l’année.
      - name: redirection_count
        description: Nombre de redirections (events `click`) sur des missions actives.
      - name: candidature_count
        description: Nombre de candidatures (events `apply`) sur des missions actives.
      - name: max_updated_at
        description: Dernière date de mise à jour observée pour l’agrégat.
  - name: mission_event
    description: >
      Mart des événements de missions. Chaque ligne reprend les informations de
      `stg_mission_event` et reclasse le champ `type` selon les règles du
      transformer historique (Created, Deleted, UpdatedStartDate, etc.) en se
      basant sur le contenu de `changes`.
    columns:
      - name: id
        description: Identifiant unique de l'événement.
        tests:
          - not_null
          - unique
      - name: mission_id
        description: Identifiant analytics de la mission concernée (Mission.id).
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: type
        description: >
          Catégorie fonctionnelle de l'événement (`Created`, `Deleted`,
          `UpdatedStartDate`, `UpdatedEndDate`, `UpdatedDescription`,
          `UpdatedActivityDomain`, `UpdatedPlaces`,
          `UpdatedJVAModerationStatus`, `UpdatedApiEngModerationStatus`,
          `UpdatedOther`).
        tests:
          - not_null
      - name: created_by
        description: Identifiant ou nom libre de l'auteur de l'événement.
      - name: created_at
        description: Date de création de l'événement.
        tests:
          - not_null
      - name: updated_at
        description: Date de dernière mise à jour (curseur incrémental).
        tests:
          - not_null
  - name: mission_moderation_status
    description: >
      Mart des statuts de modération par mission. Le modèle expose l'historique
      complet des statuts issus de `int_mission_moderation_status` pour les
      analyses et jointures dans les marts.
    columns:
      - name: id
        description: Identifiant unique du statut de modération.
        tests:
          - not_null
          - unique
      - name: mission_id
        description: Identifiant analytics de la mission concernée.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: publisher_id
        description: Identifiant du partenaire/publisher associé.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: moderation_status
        description: Statut de modération courant (enum texte).
      - name: moderation_comment
        description: Commentaire associé (nullable).
      - name: created_at
        description: Date de création du statut.
        tests:
          - not_null
      - name: updated_at
        description: Date de dernière mise à jour (curseur incrémental).
        tests:
          - not_null
