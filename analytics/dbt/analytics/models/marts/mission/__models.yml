version: 2

models:
  - name: mission
    description: >
      Mart des missions construit à partir de `int_mission`. Il enrichit les identifiants bruts
      avec les libellés de domaine/activité, expose le statut, les attributs d'accessibilité
      et les curseurs temporels nécessaires pour les analyses incrémentales.
    columns:
      - name: id
        description: Identifiant unique de la mission.
        tests:
          - not_null
          - unique
      - name: client_id
        description: Identifiant métier côté client/source.
      - name: publisher_id
        description: Identifiant du partenaire/publisher associé à la mission.
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: organization_id
        description: Identifiant de l'organization associé à la mission.
        tests:
          - relationships:
              arguments:
                to: ref('organization')
                field: id
      - name: organization_client_id
        description: Identifiant client de l'organisation côté diffuseur (nullable).
      - name: activity
        description: Libellé de l'activité (référentiel).
      - name: domain_original
        description: Libellé de domaine original.
      - name: title
        description: Titre de la mission.
      - name: description
        description: Description de la mission.
      - name: type
        description: Type de mission.
      - name: status_code
        description: Code de statut brut.
      - name: compensation_amount
        description: Montant de la compensation (nullable).
      - name: compensation_type
        description: Type de compensation (nullable).
      - name: compensation_unit
        description: Unité de compensation (nullable).
      - name: status
        description: Statut métier de la mission.
      - name: priority
        description: Priorité de la mission (nullable).
      - name: tags
        description: Tags libres associés à la mission.
      - name: tasks
        description: Liste des tâches associées à la mission.
      - name: audience
        description: Publics ciblés par la mission.
      - name: soft_skills
        description: Compétences comportementales associées.
      - name: requirements
        description: Prérequis ou conditions associées.
      - name: rome_skills
        description: Compétences ROME associées.
      - name: reduced_mobility_accessible
        description: Accessibilité aux personnes à mobilité réduite.
      - name: open_to_minors
        description: Indique si la mission est ouverte aux mineurs.
      - name: close_to_transport
        description: Indique si la mission est proche des transports.
      - name: remote
        description: Indique si la mission est réalisable à distance.
      - name: schedule
        description: Informations de planning (nullable).
      - name: duration
        description: Durée de la mission (nullable).
      - name: posted_at
        description: Date de publication initiale.
      - name: start_at
        description: Date de démarrage prévue.
      - name: end_at
        description: Date de fin prévue.
      - name: places
        description: Nombre de places proposées (nullable).
      - name: places_status
        description: Statut des places (nullable).
      - name: deleted_at
        description: Timestamp de suppression logique (nullable).
      - name: created_at
        description: Timestamp de création de la mission.
        tests:
          - not_null
      - name: updated_at
        description: Timestamp de dernière mise à jour de la mission.
        tests:
          - not_null
      - name: domain
        description: Libellé du domaine (référentiel ou libellé original).
      - name: is_deleted
        description: Drapeau booléen dérivé de `deleted_at`.
      - name: organization_name
        description: Nom déclaré de l'organisation (nullable).
      - name: organization_url
        description: URL de référence de l'organisation (nullable).
      - name: organization_type
        description: Typologie déclarée de l'organisation (nullable).
      - name: organization_logo
        description: URL ou identifiant du logo (nullable).
      - name: organization_description
        description: Description libre de l'organisation (nullable).
      - name: organization_full_address
        description: Adresse complète déclarée (nullable).
      - name: organization_rna
        description: Identifiant RNA déclaré (nullable).
      - name: organization_siren
        description: Numéro SIREN déclaré (nullable).
      - name: organization_siret
        description: Numéro SIRET déclaré (nullable).
      - name: organization_department
        description: Département déclaré (libellé, nullable).
      - name: organization_department_code
        description: Code département déclaré (nullable).
      - name: organization_department_name
        description: Nom du département déclaré (nullable).
      - name: organization_post_code
        description: Code postal déclaré (nullable).
      - name: organization_city
        description: Ville déclarée (nullable).
      - name: organization_status_juridique
        description: Statut juridique déclaré (nullable).
      - name: organization_beneficiaries
        description: Liste des bénéficiaires déclarés (nullable).
      - name: organization_actions
        description: Liste des actions déclarées (nullable).
      - name: organization_reseaux
        description: Réseaux déclarés (nullable).
      - name: organization_name_verified
        description: Statut de vérification du nom (nullable).
      - name: organization_rna_verified
        description: Statut de vérification du RNA (nullable).
      - name: organization_siren_verified
        description: Statut de vérification du SIREN (nullable).
      - name: organization_siret_verified
        description: Statut de vérification du SIRET (nullable).
      - name: organization_address_verified
        description: Statut de vérification de l'adresse (nullable).
      - name: organization_city_verified
        description: Statut de vérification de la ville (nullable).
      - name: organization_postal_code_verified
        description: Statut de vérification du code postal (nullable).
      - name: organization_department_code_verified
        description: Statut de vérification du code département (nullable).
      - name: organization_department_name_verified
        description: Statut de vérification du nom de département (nullable).
      - name: organization_region_verified
        description: Statut de vérification de la région (nullable).
      - name: organization_verification_status
        description: Statut de vérification global (nullable).
      - name: organisation_is_rup
        description: Indique si l'organisation est reconnue d'utilité publique (nullable).
  - name: mission_address
    description: >
      Mart des adresses de missions, dérivé du staging `stg_mission_address` pour exposer les localisations associées
      aux missions.
    columns:
      - name: id
        description: Identifiant unique de l'adresse.
        tests:
          - not_null
          - unique
      - name: mission_id
        description: Identifiant de la mission associée.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: street
        description: Voie/adresse déclarée (nullable).
      - name: postal_code
        description: Code postal (nullable).
      - name: department_name
        description: Nom du département (nullable).
      - name: department_code
        description: Code du département (nullable).
      - name: city
        description: Ville déclarée (nullable).
      - name: region
        description: Région déclarée (nullable).
      - name: country
        description: Pays déclaré (nullable).
      - name: location_lat
        description: Latitude géographique (nullable).
      - name: location_lon
        description: Longitude géographique (nullable).
      - name: geo_point
        description: Point géographique (nullable).

  - name: mission_active_daily
    description: >
      Vue miroir de `int_mission_active_daily` : missions actives par jour (créées avant fin de jour,
      non supprimées avant début de jour) avec département et catégorie benevolat/volontariat/all.
    columns:
      - name: active_date
        description: Jour où la mission est active.
      - name: department
        description: Code département de la mission (dédoublonné via int_mission_address).
      - name: publisher_category
        description: Catégorie de mission (benevolat / volontariat / all).
      - name: publisher_id
        description: Identifiant du publisher de la mission.
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: mission_id
        description: Identifiant de la mission.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id

  - name: mission_active_monthly
    description: >
      Agrégat mensuel des missions actives (count distinct mission_id) ventilé par département/national
      et catégorie, basé sur mission_active_daily.
    columns:
      - name: year
        description: Année de l’agrégat.
      - name: month
        description: Numéro du mois (1-12).
      - name: month_start
        description: Date de début du mois.
      - name: is_all_department
        description: TRUE pour l’agrégat national, FALSE pour l’agrégat départemental.
      - name: department
        description: Code département (null si national).
      - name: publisher_category
        description: Catégorie de mission.
      - name: mission_count
        description: Missions actives distinctes sur le mois.
      - name: geoloc_status
        description: Statut de géolocalisation (nullable).
      - name: created_at
        description: Timestamp de création de l'adresse.
      - name: updated_at
        description: Timestamp de dernière mise à jour (curseur d'export).
  - name: mission_event
    description: >
      Mart des événements de missions. Chaque ligne reprend les informations de
      `stg_mission_event` et reclasse le champ `type` selon les règles du
      transformer historique (Created, Deleted, UpdatedStartDate, etc.) en se
      basant sur le contenu de `changes`.
    columns:
      - name: id
        description: Identifiant unique de l'événement.
        tests:
          - not_null
          - unique
      - name: mission_id
        description: Identifiant analytics de la mission concernée (Mission.id).
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: type
        description: >
          Catégorie fonctionnelle de l'événement (`Created`, `Deleted`,
          `UpdatedStartDate`, `UpdatedEndDate`, `UpdatedDescription`,
          `UpdatedActivityDomain`, `UpdatedPlaces`,
          `UpdatedJVAModerationStatus`, `UpdatedApiEngModerationStatus`,
          `UpdatedOther`).
        tests:
          - not_null
      - name: created_by
        description: Identifiant ou nom libre de l'auteur de l'événement.
      - name: created_at
        description: Date de création de l'événement.
        tests:
          - not_null
      - name: updated_at
        description: Date de dernière mise à jour (curseur incrémental).
        tests:
          - not_null
  - name: mission_moderation_status
    description: >
      Mart des statuts de modération par mission. Le modèle expose l'historique
      complet des statuts issus de `int_mission_moderation_status` pour les
      analyses et jointures dans les marts.
    columns:
      - name: id
        description: Identifiant unique du statut de modération.
        tests:
          - not_null
          - unique
      - name: mission_id
        description: Identifiant analytics de la mission concernée.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: publisher_id
        description: Identifiant du partenaire/publisher associé.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: moderation_status
        description: Statut de modération courant (enum texte).
      - name: moderation_comment
        description: Commentaire associé (nullable).
      - name: created_at
        description: Date de création du statut.
        tests:
          - not_null
      - name: updated_at
        description: Date de dernière mise à jour (curseur incrémental).
        tests:
          - not_null
