version: 2

models:
  - name: global_events
    description: >
      Table de faits des événements statistiques (`stat_event`) filtrés des bots,
      avec normalisation des sources et enrichissement des publishers émetteur/récepteur.
      Sert de base aux graphiques de performance (impressions, clics, comptes, candidatures).
    columns:
      - name: stat_event_id
        description: Identifiant de l'événement `stat_event` (clé d’origine).
        tests:
          - not_null
          - unique
      - name: created_at
        description: Horodatage de création de l'événement.
        tests:
          - not_null
      - name: type
        description: Type d'événement (`click`, `apply`, `print`, `account`).
        tests:
          - not_null
      - name: source
        description: Origine normalisée (`api`, `campaign`, `widget`, etc.).
      - name: from_publisher_id
        description: UUID du partenaire diffuseur (source).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: to_publisher_id
        description: UUID du partenaire annonceur (destination).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: mission_id
        description: UUID de la mission associée.
        tests:
          - relationships:
              arguments:
                to: ref('mission')
                field: id

  - name: global_events_daily
    description: >
      Agrégats journaliers des événements `global_events` par type, source et publishers.
      Sert de base réutilisable pour des KPI et tableaux qui travaillent à la journée.
    columns:
      - name: event_date
        description: Date (jour) d’agrégation.
        tests:
          - not_null
      - name: type
        description: Type d'événement (`click`, `apply`, `print`, `account`).
        tests:
          - not_null
      - name: source
        description: Origine normalisée (`api`, `campaign`, `widget`, etc.).
      - name: source_id
        description: Identifiant de la source (widget, campagne, publisher).
      - name: from_publisher_id
        description: UUID du partenaire diffuseur (source).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: to_publisher_id
        description: UUID du partenaire annonceur (destination).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: event_count
        description: Nombre d’événements agrégés.
      - name: max_updated_at
        description: Dernière date de mise à jour observée pour l’agrégat.

  - name: global_events_monthly
    description: >
      Agrégats mensuels des événements `global_events`, ventilés par type d’événement,
      domaine de mission, type de mission (catégorie publisher) et département (ou national).
      Utilisé pour les KPI publics mensuels (redirections, candidatures).
    columns:
      - name: year
        description: Année d’agrégation.
        tests:
          - not_null
      - name: month
        description: Mois d’agrégation (1-12).
        tests:
          - not_null
      - name: month_start
        description: Date du premier jour du mois.
        tests:
          - not_null
      - name: is_all_department
        description: Indique si l’agrégat est national (true) ou départemental (false).
        tests:
          - not_null
      - name: department
        description: Code départemental (`all` pour les agrégats nationaux).
      - name: mission_domain
        description: Domaine de mission associé (`unknown` si non rattaché).
      - name: mission_type
        description: Catégorie de mission (`benevolat`, `volontariat`, `all`).
      - name: type
        description: Type d'événement (`click`, `apply`, `print`, `account`).
        tests:
          - not_null
      - name: event_count
        description: Nombre d’événements agrégés.
        tests:
          - not_null
      - name: max_updated_at
        description: Dernière date de mise à jour observée pour l’agrégat.
        tests:
          - not_null

  - name: global_mission_activity
    description: >
      Agrégat par mission/type/diffuseur/annonceur calculant les premiers et derniers
      événements observés. Utilisé pour compter les missions actives et suivre la période
      d’activité dans les tableaux et graphiques de performance.
    columns:
      - name: mission_id
        description: UUID de la mission concernée.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: type
        description: Type d'événement agrégé.
        tests:
          - not_null
      - name: from_publisher_id
        description: UUID du partenaire diffuseur.
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: to_publisher_id
        description: UUID du partenaire annonceur.
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: first_created_at
        description: Premier événement observé pour la combinaison (UTC).
        tests:
          - not_null
      - name: last_created_at
        description: Dernier événement observé pour la combinaison (UTC).
        tests:
          - not_null

  - name: mean_from_publisher_sources
    description: >
      Agrégats quotidiens des événements par diffuseur (from_publisher_id) et source
      normalisée (`api`, `campaign`, `widget`) pour alimenter l’onglet “Moyens de diffusion”.
      Le nom de source est enrichi via les dimensions `widget`, `campaign` et `publisher`.
    columns:
      - name: mean_date
        description: Date (jour) des événements agrégés.
        tests:
          - not_null
      - name: from_publisher_id
        description: UUID du partenaire diffuseur (source).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: source
        description: Source normalisée (`api`, `campaign`, `widget`).
      - name: source_id
        description: Identifiant de la source (widget, campagne, publisher).
      - name: print_count
        description: Nombre d’impressions sur la journée.
      - name: click_count
        description: Nombre de redirections sur la journée.
      - name: account_count
        description: Nombre de créations de compte sur la journée.
      - name: apply_count
        description: Nombre de candidatures sur la journée.
      - name: total_count
        description: Nombre total d’événements sur la journée.
      - name: conversion_rate
        description: Taux de conversion (candidatures / redirections).
      - name: max_updated_at
        description: Dernière date de mise à jour observée sur l’agrégat.

  - name: mean_from_publisher_sources_enriched
    description: >
      Vue enrichie de `mean_fronm_publisher_sources` qui reconstruit `source_name` via les dimensions
      `widget`, `campaign` et `publisher` pour refléter les renommages.
    columns:
      - name: mean_date
        description: Date (jour) des événements agrégés.
        tests:
          - not_null
      - name: from_publisher_id
        description: UUID du partenaire diffuseur (source).
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: source
        description: Source normalisée (`api`, `campaign`, `widget`).
      - name: source_id
        description: Identifiant de la source (widget, campagne, publisher).
      - name: source_name
        description: Libellé de la source (mis à jour via les dimensions).
      - name: print_count
        description: Nombre d’impressions sur la journée.
      - name: click_count
        description: Nombre de redirections sur la journée.
      - name: account_count
        description: Nombre de créations de compte sur la journée.
      - name: apply_count
        description: Nombre de candidatures sur la journée.
      - name: total_count
        description: Nombre total d’événements sur la journée.
      - name: conversion_rate
        description: Taux de conversion (candidatures / redirections).
