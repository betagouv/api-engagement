version: 2

models:
  - name: publisher
    description: >
      Table mart dimensionnelle des partenaires, construite à partir du staging `stg_publisher` et alignée sur le
      schéma attendu par Metabase (`diffuseur_*`, `annonceur`). Ce modèle remplace la table alimentée historiquement
      par le job Prisma.
    columns:
      - name: id
        description: Identifiant unique du partenaire.
        tests:
          - not_null
          - unique
      - name: name
        description: Nom officiel du partenaire tel qu'il sera affiché dans Metabase.
      - name: diffuseur_api
        description: Flag indiquant si le partenaire diffuse des missions via l'API.
        tests:
          - not_null
      - name: diffuseur_widget
        description: Flag indiquant l'accès aux widgets embarqués.
        tests:
          - not_null
      - name: diffuseur_campaign
        description: Flag indiquant l'accès aux campagnes / emails.
        tests:
          - not_null
      - name: is_annonceur
        description: Flag indiquant si le partenaire agit comme annonceur (receveur de candidatures).
        tests:
          - not_null
      - name: created_at
        description: Horodatage de création (UTC).
      - name: updated_at
        description: Horodatage de dernière mise à jour, utilisé pour l'incrémental.
        tests:
          - not_null
      - name: deleted_at
        description: Horodatage de suppression logique (nullable).
  - name: annonceur
    description: >
      Vue filtrée des partenaires marqués comme annonceurs (`is_annonceur = true`). Le modèle expose les mêmes colonnes
      que `stg_publisher` mais restreint aux entités recevant des candidatures.
    columns:
      - name: id
        description: Identifiant unique du partenaire annonceur.
        tests:
          - not_null
          - unique
      - name: name
        description: Nom du partenaire.
      - name: is_annonceur
        description: Flag toujours à `true`, rappelant le filtre appliqué.
      - name: created_at
        description: Horodatage de création.
      - name: updated_at
        description: Horodatage de dernière mise à jour.
        tests:
          - not_null
  - name: diffuseur
    description: >
      Vue filtrée des partenaires qui ne sont pas annonceurs (`is_annonceur = false`). Utile pour isoler les diffuseurs
      historiques (widgets/API/campagnes) dans Metabase.
    columns:
      - name: id
        description: Identifiant unique du partenaire diffuseur.
        tests:
          - not_null
          - unique
      - name: name
        description: Nom du partenaire.
      - name: is_annonceur
        description: Flag toujours à `false`, rappelant le filtre appliqué.
      - name: created_at
        description: Horodatage de création.
      - name: updated_at
        description: Horodatage de dernière mise à jour.
        tests:
          - not_null
  - name: publisher_organization
    description: >
      Vue mart des organisations rattachées aux partenaires, directement dérivée de `int_publisher_organization` pour
      exposer les informations organisationnelles dans la couche analytics.
    columns:
      - name: id
        description: Identifiant unique de la relation partenaire / organisation.
        tests:
          - not_null
          - unique
      - name: publisher_id
        description: Identifiant du partenaire diffuseur associé.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: organization_client_id
        description: Identifiant client de l'organisation côté diffuseur.
        tests:
          - not_null
      - name: organization_name
        description: Nom déclaré de l'organisation (nullable).
      - name: organization_rna
        description: Identifiant RNA déclaré (nullable).
      - name: organization_siren
        description: Numéro SIREN déclaré (nullable).
      - name: organization_siret
        description: Numéro SIRET déclaré (nullable).
      - name: organisation_is_rup
        description: Indique si l'organisation est reconnue d'utilité publique (nullable).
      - name: created_at
        description: Horodatage de création.
      - name: updated_at
        description: Horodatage de dernière mise à jour.
        tests:
          - not_null
  - name: publisher_diffusion_exclusion
    description: >
      Table de faits légère listant les exclusions de diffusion entre partenaires, enrichie des libellés annonceur et
      diffuseur pour faciliter les analyses Metabase.
    columns:
      - name: id
        description: Identifiant unique de la règle d'exclusion.
        tests:
          - not_null
          - unique
      - name: excluded_by_annonceur_id
        description: Identifiant du partenaire annonceur à l'origine du blocage.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: excluded_by_annonceur_name
        description: Nom du partenaire annonceur (nullable si inconnu).
      - name: excluded_by_annonceur_deleted_at
        description: Timestamp de suppression logique de l'annonceur (nullable).
      - name: excluded_for_diffuseur_id
        description: Identifiant du partenaire diffuseur ciblé.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: excluded_for_diffuseur_name
        description: Nom du partenaire diffuseur (nullable si inconnu).
      - name: excluded_for_diffuseur_deleted_at
        description: Timestamp de suppression logique du diffuseur (nullable).
      - name: organization_client_id
        description: Identifiant client de l'organisation exclue (nullable).
      - name: organization_name
        description: Nom libre de l'organisation exclue (nullable).
      - name: created_at
        description: Horodatage de création de la règle.
      - name: updated_at
        description: Horodatage de dernière mise à jour, utilisé comme curseur d'export.
        tests:
          - not_null
