version: 2

models:
  - name: int_mission
    description: >
      Vue intermédiaire des missions combinant les identifiants bruts, les libellés
      de domaine/activité et quelques dérivés (status, is_deleted).
      Sert de base aux marts et facilite les jointures descendantes.
    columns:
      - name: id
        description: Identifiant unique de la mission.
        tests:
          - not_null
          - unique
      - name: publisher_id
        description: Identifiant du partenaire/publisher associé à la mission.
        tests:
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: organization_client_id
        description: Identifiant client de l'organisation côté diffuseur (nullable).
      - name: domain
        description: Libellé du domaine (préférence pour le référentiel, fallback sur `domain_original`).
      - name: activity
        description: Libellé de l'activité issue du référentiel.
      - name: status
        description: Statut métier de la mission (alias de `status_code`).
      - name: updated_at
        description: Timestamp de dernière mise à jour.
        tests:
          - not_null
      - name: moderation_status
        description: Dernier statut de modération connu pour la mission.
      - name: moderation_comment
        description: Dernier commentaire de modération associé (nullable).
  - name: int_mission_address
    description: >
      Table intermédiaire des adresses de missions, construite en incrémental à partir
      de `stg_mission_address` pour stabiliser les jointures et les marts.
    columns:
      - name: id
        description: Identifiant unique de l'adresse.
        tests:
          - not_null
          - unique
      - name: mission_id
        description: Identifiant de la mission associée.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: street
        description: Voie/adresse déclarée (nullable).
      - name: postal_code
        description: Code postal (nullable).
      - name: department_name
        description: Nom du département (nullable).
      - name: department_code
        description: Code du département (nullable).
      - name: city
        description: Ville déclarée (nullable).
      - name: region
        description: Région déclarée (nullable).
      - name: country
        description: Pays déclaré (nullable).
      - name: location_lat
        description: Latitude géographique (nullable).
      - name: location_lon
        description: Longitude géographique (nullable).
      - name: geo_point
        description: Point géographique (nullable).
      - name: geoloc_status
        description: Statut de géolocalisation (nullable).
      - name: created_at
        description: Timestamp de création de l'adresse.
      - name: updated_at
        description: Timestamp de dernière mise à jour (curseur incrémental).
        tests:
          - not_null
  - name: int_mission_moderation_status
    description: >
      Vue intermédiaire des statuts de modération par mission, issue de
      `stg_mission_moderation_status` et chargée en incrémental sur `updated_at`.
      Sert à enrichir le mart mission avec le statut et le commentaire courants.
    columns:
      - name: id
        description: Identifiant UUID de la ligne côté core.
        tests:
          - not_null
          - unique
      - name: mission_id
        description: Identifiant analytics de la mission concernée.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: publisher_id
        description: Identifiant du partenaire diffuseur.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: moderation_status
        description: Statut de modération courant (enum texte).
      - name: moderation_comment
        description: Commentaire associé (nullable).
      - name: created_at
        description: Date de création du statut.
        tests:
          - not_null
      - name: updated_at
        description: Date de dernière mise à jour (curseur incrémental).
        tests:
          - not_null
  - name: int_mission_active_range
    description: >
      Vue intermédiaire au grain mission, qui expose la période d'activité (start_date/end_date)
      sans déplier en jours. La date de fin reste null tant que la mission est active.
    columns:
      - name: mission_id
        description: Identifiant de la mission.
        tests:
          - not_null
          - unique
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: start_date
        description: Date de début de la mission (jour de création).
        tests:
          - not_null
      - name: end_date
        description: Date de fin de la mission (jour de suppression, null si active).
      - name: mission_domain
        description: Domaine de la mission.
      - name: publisher_id
        description: Identifiant du publisher de la mission.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: publisher_category
        description: Catégorie de mission (benevolat / volontariat).
      - name: updated_at
        description: Timestamp de dernière mise à jour propagé depuis la mission.
        tests:
          - not_null
  - name: int_mission_active_department_range
    description: >
      Vue intermédiaire au grain mission-département qui expose la période d'activité (start/end)
      sans déplier en jours. Duplique `int_mission_active_range` pour chaque département associé
      à la mission (dédoublonnage par mission et code département).
    columns:
      - name: mission_id
        description: Identifiant de la mission.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: start_date
        description: Date de début de la mission (jour de création).
        tests:
          - not_null
      - name: end_date
        description: Date de fin de la mission (jour de suppression, null si active).
      - name: department
        description: Code département associé (dédoublonné par mission et code).
      - name: publisher_id
        description: Identifiant du publisher de la mission.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('publisher')
                field: id
      - name: publisher_category
        description: Catégorie de mission (benevolat / volontariat).
      - name: mission_domain
        description: Domaine de la mission.
      - name: updated_at
        description: Timestamp de dernière mise à jour propagé depuis la mission/adresse.
        tests:
          - not_null
  - name: int_mission_first_events
    description: >
      Vue intermédiaire au grain mission + diffuseur + source, qui expose les premières
      dates de click/apply et les délais depuis la création de la mission.
    columns:
      - name: mission_id
        description: Identifiant de la mission.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('mission')
                field: id
      - name: mission_created_at
        description: Timestamp de création de la mission (base des délais).
        tests:
          - not_null
      - name: from_publisher_id
        description: Identifiant du diffuseur à l'origine de l'événement (nullable).
      - name: source
        description: Source normalisée de l'événement (api, widget, campaign).
      - name: source_id
        description: Identifiant de la source (widget/campaign/publisher selon source).
      - name: first_click_at
        description: Timestamp du premier click observé sur la mission.
      - name: first_apply_at
        description: Timestamp de la première candidature observée sur la mission.
      - name: click_count
        description: Nombre total de redirections (click) observées pour la mission.
        tests:
          - not_null
      - name: apply_count
        description: Nombre total de candidatures (apply) observées pour la mission.
        tests:
          - not_null
      - name: conversion_rate
        description: Ratio candidatures/redirections (`apply_count / click_count`).
      - name: time_to_click_secs
        description: Délai en secondes entre création de mission et premier click.
      - name: time_to_apply_secs
        description: Délai en secondes entre création de mission et première candidature.
      - name: mission_duration_days
        description: Durée de mission en jours (différence entre start_at et end_at).
      - name: updated_at
        description: Timestamp de dernière mise à jour propagé mission/événements.
        tests:
          - not_null
