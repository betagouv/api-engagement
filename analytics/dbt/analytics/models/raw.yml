version: 2

sources:
  - name: public
    description: Tables déjà présentes dans le schéma `public`.
    schema: public
    tables:
      - name: Partner
      - name: Mission
      - name: Widget
      - name: Campaign
  - name: analytics_raw
    description: Données brutes synchronisées depuis la base opérationnelle `analytics_raw`.
    schema: analytics_raw
    loader: node job export-to-analytics-raw
    tables:
      - name: stat_event
        description: >-
          Événements de statistiques (impressions, clics, candidatures, création de compte) exportés depuis la base `core`
          pour alimenter l'entrepôt analytics. Chaque ligne correspond à une action utilisateur observée, enrichie des
          identifiants partenaires et missions.
        columns:
          - name: id
            description: Identifiant unique de l'événement issu de l'application source.
          - name: type
            description: Type d'événement (`click`, `print`, `apply`, `account`).
          - name: created_at
            description: Horodatage (UTC) de la collecte de l'événement.
          - name: updated_at
            description: Horodatage (UTC) de la mise à jour de l'événement.
          - name: click_id
            description: Identifiant d'un clic associé (si pertinent).
          - name: referer
            description: URL de provenance envoyée par le navigateur.
          - name: host
            description: Domaine sur lequel l'événement a été déclenché.
          - name: is_bot
            description: Indique si l'événement est classé comme bot (`true`) selon les règles de détection actuelles.
          - name: is_human
            description: Indique si l'événement est classé comme humain (`true`).
          - name: source
            description: Origine de la collecte (`api`, `widget`, `campaign`, `seo`, `jstag`, `publisher`).
          - name: source_id
            description: Identifiant métier associé à la source (id widget, campagne, etc.).
          - name: from_publisher_id
            description: Identifiant du partenaire diffuseur (source).
          - name: to_publisher_id
            description: Identifiant du partenaire receveur (annonceur).
          - name: mission_id
            description: Identifiant de la mission dans la base analytics (nullable).
          - name: mission_client_id
            description: Identifiant métier de la mission côté client/source (nullable).
          - name: tag
            description: Tag principal associé à l'événement (nullable).
          - name: tags
            description: Liste (array) de tags complémentaires (nullable).
          - name: status
            description: Statut métier de l'événement (ex. `PENDING`, `VALIDATED`, `CANCELED`).
          - name: custom_attributes
            description: Attributs personnalisés en JSON (nullable) fournis par la source.
      - name: email
        description: >-
          Emails transactionnels et rapports générés côté application (table `public.email` de la base core)
          synchronisés tels quels dans le schéma `analytics_raw`.
        columns:
          - name: id
            description: Identifiant unique de l'email (UUID).
          - name: message_id
            description: Identifiant du message dans le provider SMTP (nullable).
          - name: in_reply_to
            description: Identifiant du message parent (si réponse).
          - name: from_name
            description: Nom complet de l'expéditeur.
          - name: from_email
            description: Adresse email de l'expéditeur.
          - name: to
            description: Payload JSON des destinataires (format brut).
          - name: to_emails
            description: Tableau textuel des adresses email destinataires.
          - name: subject
            description: Sujet de l'email.
          - name: sent_at
            description: Timestamp d'envoi effectif.
          - name: raw_text_body
            description: Contenu texte brut.
          - name: raw_html_body
            description: Contenu HTML brut.
          - name: md_text_body
            description: Contenu Markdown pré-calculé.
          - name: attachments
            description: Pièces jointes (JSON listant les métadonnées).
          - name: raw
            description: Payload complet sérialisé (JSON).
          - name: status
            description: Statut métier (`PENDING`, `PROCESSED`, etc.).
          - name: report_url
            description: URL publique vers le rapport généré (nullable).
          - name: file_object_name
            description: Nom de l'objet correspondant dans le stockage fichier.
          - name: date_from
            description: Date de début couverte par le rapport (nullable).
          - name: date_to
            description: Date de fin couverte par le rapport (nullable).
          - name: created_count
            description: Nombre de lignes/objets créés lors de la génération (nullable).
          - name: failed
            description: Détails des erreurs éventuelles (JSON).
          - name: deleted_at
            description: Horodatage de suppression logique.
          - name: created_at
            description: Timestamp de création de la ligne.
          - name: updated_at
            description: Timestamp de dernière mise à jour (curseur d'export).
      - name: moderation_event
        description: >-
          Historique des actions de modération issues de la base core. Chaque enregistrement trace l'état initial et
          final d'une mission après intervention d'un modérateur (automatique ou humain).
        columns:
          - name: id
            description: Identifiant unique de l'événement de modération côté analytics.
          - name: mission_id
            description: Identifiant de la mission concernée.
          - name: created_at
            description: Date de création de l'événement (UTC).
          - name: updated_at
            description: Dernière mise à jour (UTC), utilisée pour l'incrémentalité.
          - name: moderator_id
            description: Identifiant de l'utilisateur/modérateur à l'origine du changement.
          - name: user_name
            description: Nom libre stocké lors de l'action (ex. modération automatique).
          - name: initial_status
            description: Statut de la mission avant la modération.
          - name: new_status
            description: Statut de la mission après la modération.
          - name: initial_comment
            description: Commentaire initial (le cas échéant).
          - name: new_comment
            description: Nouveau commentaire appliqué.
          - name: initial_note
            description: Note initiale.
          - name: new_note
            description: Nouvelle note.
          - name: initial_title
            description: Ancien titre de mission connu avant modification.
          - name: new_title
            description: Nouveau titre de mission.
          - name: initial_siren
            description: Ancien numéro SIREN associé.
          - name: new_siren
            description: Nouveau numéro SIREN.
          - name: initial_rna
            description: Ancien identifiant RNA.
          - name: new_rna
            description: Nouvel identifiant RNA.
      - name: publisher
        description: >-
          Instantané des partenaires / diffuseurs tels qu'ils existent dans la base opérationnelle. Chaque ligne
          correspond à un partenaire et inclut les droits d'accès ainsi que les liaisons diffuseurs-annonceurs
          nécessaires pour reconstruire le champ `partners`.
        columns:
          - name: id
            description: Identifiant unique du partenaire (UUID `publisher.id`).
          - name: name
            description: Nom public du partenaire.
          - name: category
            description: Catégorie fonctionnelle saisie dans l'application source (nullable).
          - name: is_annonceur
            description: Indique si le partenaire agit comme annonceur côté API.
          - name: has_api_rights
            description: Droit d'accès aux flux API sortants.
          - name: has_widget_rights
            description: Droit d'accès aux widgets embarqués.
          - name: has_campaign_rights
            description: Droit d'accès aux campagnes (Sendinblue, emailing).
          - name: deleted_at
            description: Timestamp de suppression logique dans l'app source (nullable).
          - name: created_at
            description: Timestamp de création du partenaire.
          - name: updated_at
            description: Timestamp de dernière mise à jour, utilisé comme curseur d'export.
      - name: mission_event
        description: >-
          Événements de mission générés lors des imports (create/update/delete) sur la base Mongo historique,
          exportés vers Postgres pour tracer les modifications des missions et alimenter les historiques analytics.
        columns:
          - name: id
            description: Identifiant unique de l'événement.
          - name: mission_id
            description: Identifiant Mongo de la mission concernée (Mission.old_id).
          - name: type
            description: Type brut de l'événement (`create`, `update`, `delete`).
          - name: changes
            description: Payload JSON décrivant les champs modifiés (previous/current).
          - name: created_by
            description: Identifiant ou libellé de l'utilisateur/processus à l'origine de l'événement.
          - name: created_at
            description: Date de création de l'événement (UTC).
          - name: updated_at
            description: Dernière mise à jour (UTC), utilisée comme curseur d'export.
      - name: organization
        description: >-
          Référentiel des organisations synchronisé depuis la base opérationnelle (`core.Organization`). Ces données
          décrivent les associations/réseaux partenaires (identité, adresses, informations administratives) nécessaires
          pour les analyses métiers et les jointures avec les missions/partenaires.
        columns:
          - name: id
            description: Identifiant unique de l'organisation (UUID).
          - name: gestion
            description: Code ou libellé de gestion remonté par l'application source (nullable).
          - name: status
            description: Statut administratif/associatif déclaré (nullable).
          - name: created_at
            description: Horodatage de création de l'organisation côté source.
          - name: last_declared_at
            description: Date de dernière déclaration connue (nullable).
          - name: published_at
            description: Date de publication officielle (nullable).
          - name: dissolved_at
            description: Date de dissolution si l'organisation n'est plus active (nullable).
          - name: updated_at
            description: Horodatage de dernière mise à jour, utilisé comme curseur d'export incrémental.
          - name: nature
            description: Nature juridique déclarée (nullable).
          - name: groupement
            description: Information de groupement ou fédération (nullable).
          - name: title
            description: Titre long officiel de l'organisation.
          - name: short_title
            description: Titre court utilisé dans certaines interfaces (nullable).
          - name: names
            description: Variantes de noms déclarés (tableau textuel).
          - name: address_insee_code
            description: Code INSEE correspondant à l'adresse principale (nullable).
          - name: address_postal_code
            description: Code postal de l'adresse principale (nullable).
          - name: address_department_code
            description: Code du département lié à l'adresse principale (nullable).
          - name: address_department_name
            description: Libellé du département lié à l'adresse principale (nullable).
          - name: address_region
            description: Région correspondant à l'adresse principale (nullable).
          - name: address_city
            description: Ville correspondant à l'adresse principale (nullable).
          - name: management_postal_code
            description: Code postal utilisé pour l'adresse de gestion (nullable).
          - name: management_city
            description: Ville utilisée pour l'adresse de gestion (nullable).
          - name: management_country
            description: Pays utilisé pour l'adresse de gestion (nullable).
          - name: director_civility
            description: Civilité du dirigeant/président déclaré (nullable).
          - name: source
            description: Origine de la donnée (ex. `rna`, `api`, `manual`).
      - name: import
        description: >-
          Journal d'exécution des imports de missions côté partenaires (job `export-to-analytics-raw`). Chaque ligne
          agrège les totaux créés/supprimés/mis à jour ainsi que le partenaire et la fenêtre temporelle de l'import.
        columns:
          - name: id
            description: Identifiant unique de l'import dans la base source.
          - name: name
            description: Nom libre de l'import (généralement décrit par le job déclencheur).
          - name: publisher_id
            description: Identifiant du partenaire concerné par l'import.
          - name: mission_count
            description: Volume total de missions parcourues pendant l'import.
          - name: refused_count
            description: Nombre de missions refusées (statut non importé) durant l'import.
          - name: created_count
            description: Nombre de missions créées côté application durant cette exécution.
          - name: deleted_count
            description: Nombre de missions supprimées/supprimées logiquement durant cette exécution.
          - name: updated_count
            description: Nombre de missions mises à jour durant cette exécution.
          - name: started_at
            description: Horodatage de démarrage de l'import (UTC).
          - name: finished_at
            description: Horodatage de fin de l'import, utilisé comme curseur temporel pour l'incrémentalité.
          - name: status
            description: Statut global retourné par le job (`SUCCESS`, `FAILED`, etc.).
      - name: publisher_diffusion_exclusion
        description: >-
          Exclusions de diffusion configurées entre partenaires (annonceur -> diffuseur) telles que synchronisées depuis
          la base opérationnelle. Chaque ligne correspond à une règle interdisant à un diffuseur de relayer des missions
          pour un annonceur donné.
        columns:
          - name: id
            description: Identifiant unique de la règle d'exclusion.
          - name: excluded_by_annonceur_id
            description: Identifiant du partenaire annonceur qui crée l'exclusion.
          - name: excluded_for_diffuseur_id
            description: Identifiant du partenaire diffuseur visé par l'exclusion.
          - name: organization_client_id
            description: Identifiant métier de l'organisation concernée par l'exclusion (nullable).
          - name: organization_name
            description: Libellé texte de l'organisation exclue (nullable).
          - name: created_at
            description: Timestamp de création de la règle côté application source.
          - name: updated_at
            description: Timestamp de dernière mise à jour, utilisé comme curseur d'export incrémental.
      - name: user
        description: >-
          Comptes utilisateurs applicatifs synchronisés depuis la base `core.user`. Ces données servent de référentiel
          pour analyser les habilitations, rôles et activités dans Metabase.
        columns:
          - name: id
            description: Identifiant unique du compte utilisateur (UUID).
          - name: first_name
            description: Prénom renseigné lors de la création du compte.
          - name: last_name
            description: Nom de famille renseigné (nullable).
          - name: email
            description: Adresse email utilisée pour se connecter à la plateforme.
          - name: role
            description: Rôle applicatif (`ADMIN`, `PUBLISHER`, `OPERATOR`, etc.).
          - name: deleted_at
            description: Timestamp de suppression logique (nullable).
          - name: last_activity_at
            description: Dernière activité connue dans l'application (nullable).
          - name: created_at
            description: Timestamp de création du compte.
          - name: updated_at
            description: Timestamp de dernière mise à jour, utilisé comme curseur d'export incrémental.
      - name: user_publisher
        description: >-
          Table de liaison entre les comptes utilisateurs et les partenaires qu'ils administrent. Permet de suivre les
          rattachements et leurs dates de création/mise à jour.
        columns:
          - name: id
            description: Identifiant unique du rattachement.
          - name: user_id
            description: Identifiant de l'utilisateur référencé dans `analytics_raw.user`.
          - name: publisher_id
            description: Identifiant du partenaire référencé dans `analytics_raw.publisher`.
          - name: created_at
            description: Timestamp de création du rattachement.
          - name: updated_at
            description: Timestamp de dernière mise à jour (curseur d'export).
